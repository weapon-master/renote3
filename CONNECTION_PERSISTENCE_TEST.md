# 连接数据持久化测试

## 问题描述
连接数据在关闭笔记视图后重新打开时被删除的问题。

## 修复内容

### 1. 添加用户操作标志
- 添加了 `isUserAction` useRef 来跟踪是否是用户操作导致的连接变化
- 只有在用户操作时才保存连接到数据库

### 2. 修改数据库保存逻辑
- 修改了 `batchUpdateNoteConnections` 函数，只在有连接时才执行删除和插入操作
- 避免了在初始加载时删除现有连接

### 3. 改进组件生命周期管理
- 添加了 `hasInitialized` 状态来跟踪初始化完成
- 在加载完成后才允许保存操作

## 测试步骤

### 测试 1: 基本连接创建和持久化
1. 打开一个包含注释的书籍
2. 打开笔记视图
3. 创建几个连接（拖拽或右键点击）
4. 关闭笔记视图
5. 重新打开笔记视图
6. **预期结果**: 连接应该仍然存在

### 测试 2: 连接方向修改
1. 在现有连接上右键点击修改方向
2. 关闭笔记视图
3. 重新打开笔记视图
4. **预期结果**: 连接方向应该保持修改后的状态

### 测试 3: 连接描述添加
1. 双击连接添加描述
2. 关闭笔记视图
3. 重新打开笔记视图
4. **预期结果**: 连接描述应该保持

### 测试 4: 清除连接
1. 点击"Clear Connections"按钮
2. 关闭笔记视图
3. 重新打开笔记视图
4. **预期结果**: 连接应该保持清除状态

### 测试 5: 注释删除导致的连接清理
1. 创建一些连接
2. 删除其中一个注释
3. 关闭笔记视图
4. 重新打开笔记视图
5. **预期结果**: 与被删除注释相关的连接应该被清理，其他连接应该保持

## 修复的关键点

1. **避免竞态条件**: 使用 `isUserAction` 标志确保只有用户操作才触发保存
2. **保护现有数据**: 在 `batchUpdateNoteConnections` 中只在有连接时才删除现有数据
3. **正确的初始化顺序**: 确保在加载完成后才允许保存操作

## 代码变更

### NotesView.tsx
- 添加了 `isUserAction` useRef
- 添加了 `hasInitialized` 状态
- 修改了所有用户操作函数以设置 `isUserAction.current = true`
- 修改了保存连接的 useEffect 逻辑

### connection.ts
- 修改了 `batchUpdateNoteConnections` 函数，只在有连接时才执行删除和插入

这些修复应该解决连接数据在重新打开笔记视图时被删除的问题。
